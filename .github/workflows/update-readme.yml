name: Activity Tracker

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  auto-activity:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Random delay
        run: |
          # Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ° 0â€“20 Ð¼Ð¸Ð½ÑƒÑ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹ Ð±Ñ‹Ð»Ð¸ Ð² Ñ€Ð°Ð·Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ
          DELAY=$((RANDOM % 1200))
          echo "Sleeping for $DELAY seconds..."
          sleep $DELAY

      - name: Maybe log a heartbeat
        run: |
          mkdir -p logs
          DO_UPDATE=$((RANDOM % 10))
          if [ $DO_UPDATE -lt 8 ]; then
            TIME=$(date -u)
            RAND=$((RANDOM % 100000))
            echo "Heartbeat at ${TIME} â€” ${RAND}" >> heartbeat.log
            echo "âœ… Logged heartbeat: ${TIME} (${RAND})"
          else
            echo "ðŸ•’ Skipping this run (random skip)."
            exit 0
          fi

      - name: Update README with last 5 heartbeats
        run: |
          echo "Updating README with latest heartbeats..."
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ð±Ð»Ð¾Ðº
          echo "### ðŸ©µ Recent Activity" > section.txt
          echo "" >> section.txt
          tail -n 5 heartbeat.log | tac | while read -r line; do
            echo "- ${line}" >> section.txt
          done
          echo "" >> section.txt
          
          # Ð•ÑÐ»Ð¸ ÑÐµÐºÑ†Ð¸Ñ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ â€” Ð·Ð°Ð¼ÐµÐ½ÑÐµÐ¼ ÐµÑ‘, Ð¸Ð½Ð°Ñ‡Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² ÐºÐ¾Ð½ÐµÑ†
          if grep -q "### ðŸ©µ Recent Activity" README.md; then
            awk '/### ðŸ©µ Recent Activity/{flag=1;print;next}/^$/{if(flag){flag=0}else{print}}' README.md > tmp.md
            head -n -0 README.md > tmp.md
            sed -i '/### ðŸ©µ Recent Activity/,$d' README.md
          fi
          cat section.txt >> README.md
          rm -f section.txt tmp.md

      - name: Commit and push
        run: |
          git config user.name "famouswizard"
          git config user.email "sonverser@gmail.com"
          git add README.md heartbeat.log
          git commit -m "Heartbeat update: $(date -u)" || echo "No changes"
          git push
